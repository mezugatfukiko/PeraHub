<!-- templates/finance/dashboard.html -->

{% extends 'base.html' %} {% load static %} {% block content %}
<div class="p-6 bg-gray-100 text-gray-800">
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-semibold">Hello, {{ user.first_name }} ðŸ‘‹</h2>
      <p class="text-sm text-gray-600">Your finances at a glance.</p>
    </div>
    <div class="text-right">
      <p class="font-bold">{{ user.get_full_name }}</p>
      <p class="text-sm text-gray-500">{{ user.email }}</p>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 mt-6">
    <div class="bg-purple-100 p-4 rounded-lg shadow">
      <h4>Total Income</h4>
      <p class="text-2xl font-bold">â‚±{{ income|floatformat:2 }}</p>
    </div>
    <div class="bg-purple-100 p-4 rounded-lg shadow">
      <h4>Total Expenses</h4>
      <p class="text-2xl font-bold">â‚±{{ expenses|floatformat:2 }}</p>
    </div>
    <div class="bg-purple-100 p-4 rounded-lg shadow">
      <h4>Remaining Balance</h4>
      <p class="text-2xl font-bold">â‚±{{ balance|floatformat:2 }}</p>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 mt-6">
    <div class="bg-purple-100 p-4 rounded-lg">
      <h4 class="font-semibold">Where Your Money Goes</h4>
      <div class="mt-2 relative" style="height: 200px">
        <canvas id="expenseChart" width="400" height="400"></canvas>
      </div>
      <!-- Optional: Keep the percentage list below the chart -->
      <ul class="mt-2 text-xs text-gray-600">
        {% for label, value in chart_data.items %}
        <li>{{ label }}: {{ value }}%</li>
        {% endfor %}
      </ul>
    </div>

    <div class="bg-purple-100 p-4 rounded-lg">
      <h4 class="font-semibold">Income vs Expenses</h4>
      <p class="text-sm text-gray-600 mt-4">[Chart Placeholder]</p>
    </div>

    <div class="bg-purple-100 p-4 rounded-lg">
      <h4 class="font-semibold">Add New Entry</h4>
      <form method="POST" class="mt-2">
        {% csrf_token %}
        <input
          type="text"
          name="title"
          placeholder="Title"
          class="block w-full mb-2 p-1 border rounded"
        />
        <input
          type="number"
          name="amount"
          placeholder="Amount"
          class="block w-full mb-2 p-1 border rounded"
        />
        <input
          type="date"
          name="date"
          class="block w-full mb-2 p-1 border rounded"
        />
        <select name="type" class="block w-full mb-2 p-1 border rounded">
          <option>Income</option>
          <option>Expense</option>
        </select>
        <textarea
          name="notes"
          placeholder="Notes (optional)"
          class="block w-full mb-2 p-1 border rounded"
        ></textarea>
        <button type="submit" class="bg-green-500 text-white px-4 py-1 rounded">
          Add Entry
        </button>
      </form>
    </div>
  </div>

  <div class="mt-8">
    <h4 class="text-xl font-semibold mb-2">Entries List</h4>
    <table class="w-full bg-white rounded shadow text-sm">
      <thead>
        <tr class="bg-purple-200 text-left">
          <th class="p-2">Title</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Type</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
        <tr class="border-t">
          <td class="p-2">{{ entry.title }}</td>
          <td>{{ entry.amount }}</td>
          <td>{{ entry.date }}</td>
          <td>{{ entry.type }}</td>
          <td>{{ entry.notes }}</td>
          <td>
            <a href="{% url 'edit_entry' entry.id %}" class="text-blue-500"
              >Edit</a
            >
            <a
              href="{% url 'delete_entry' entry.id %}"
              class="text-red-500 ml-2"
              >Delete</a
            >
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center p-4">No entries yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Check if chart element exists
      const ctx = document.getElementById('expenseChart');
      if (!ctx) {
          console.error('Expense chart element not found');
          return;
      }

      // Prepare chart data
      const chartData = {
          labels: [],
          values: [],
          // Purple-themed colors
          backgroundColors: [
              '#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95',
              '#A78BFA', '#C4B5FD', '#EDE9FE', '#DDD6FE'
          ]
      };

      {% if chart_data %}
          {% for label, value in chart_data.items %}
              chartData.labels.push("{{ label }}");
              chartData.values.push({{ value }});
          {% endfor %}
      {% endif %}

      // Fallback if no data
      if (chartData.labels.length === 0) {
          chartData.labels = ['No data'];
          chartData.values = [100];
          chartData.backgroundColors = ['#E5E7EB'];
      }

      // Create the chart
      new Chart(ctx, {
          type: 'pie',
          data: {
              labels: chartData.labels,
              datasets: [{
                  data: chartData.values,
                  backgroundColor: chartData.backgroundColors.slice(0, chartData.labels.length),
                  borderColor: '#FFFFFF',
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'right',
                      labels: {
                          usePointStyle: true,
                          padding: 16,
                          font: {
                              size: 11
                          }
                      }
                  },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              return `${context.label}: ${context.raw}%`;
                          }
                      }
                  }
              }
          }
      });
  });
</script>
{% endblock %}
